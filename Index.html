<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>ðŸŒ± Smart Agriculture + AI Advisor</title>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #e6ee9c);
      margin: 0;
      padding: 20px;
      color: #111;
    }

    h1 {
      text-align: center;
      margin-bottom: 25px;
      font-size: 28px;
      color: #2e7d32;
      text-shadow: 1px 1px 2px #c8e6c9;
    }

    /* Sensor Cards Container */
    .card-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .card {
      background: #ffffff;
      padding: 20px;
      border-radius: 16px;
      min-width: 160px;
      text-align: center;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease-in-out;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card h2 {
      font-size: 20px;
      color: #1565c0;
    }

    .value {
      font-size: 24px;
      font-weight: bold;
      margin-top: 10px;
      color: #333;
    }

    /* Crop Suggestion */
    #crop-suggestion {
      background: #dbeafe;
      padding: 15px;
      border-radius: 12px;
      font-size: 20px;
      margin: 20px auto;
      text-align: center;
      max-width: 600px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    #predict-btn {
      display: block;
      margin: 0 auto 30px;
      padding: 12px 20px;
      background: #2e7d32;
      color: white;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s ease-in-out;
    }

    #predict-btn:hover {
      background: #1b5e20;
    }

    /* Chatbot */
    #chatbot {
      background: #ffffff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.2);
      max-width: 450px;
      margin: auto;
    }

    #chatbot h2 {
      text-align: center;
      color: #1565c0;
      margin-bottom: 15px;
    }

    #chat-window {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 12px;
      margin-bottom: 12px;
      background: #fafafa;
    }

    .message {
      margin: 6px 0;
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 75%;
      word-wrap: break-word;
      font-size: 14px;
      line-height: 1.4;
    }

    .user {
      background: #2563eb;
      color: #fff;
      margin-left: auto;
    }

    .bot {
      background: #e5e7eb;
      color: #111;
      margin-right: auto;
    }

    /* Chat input */
    .chat-input {
      display: flex;
      gap: 10px;
    }

    input {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      border-radius: 10px;
      border: 1px solid #ccc;
      outline: none;
    }

    input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 5px rgba(37, 99, 235, 0.4);
    }

    button {
      padding: 10px 16px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s ease-in-out;
    }

    button:hover {
      background: #1d4ed8;
    }
  </style>
</head>

<body>
  <h1>ðŸŒ± ESP32 Agriculture Monitor + AI Crop Advisor</h1>

  <!-- Sensor Cards -->
  <div class="card-container">
    <div class="card">
      <h2>Moisture</h2>
      <div id="moisture" class="value">-- %</div>
    </div>
    <div class="card">
      <h2>Temperature</h2>
      <div id="temperature" class="value">-- Â°C</div>
    </div>
    <div class="card">
      <h2>Humidity</h2>
      <div id="humidity" class="value">-- %</div>
    </div>
  </div>

  <!-- Crop Suggestion -->
  <div id="crop-suggestion">ðŸŒ¾ Best Crop Suggestion: --</div>
  <button id="predict-btn">Get Crop Suggestion</button>

  <!-- Chatbot -->
  <div id="chatbot">
    <h2>ðŸ¤– AI Crop Chatbot</h2>
    <div id="chat-window"></div>
    <div class="chat-input">
      <input type="text" id="user-input" placeholder="Ask about crops...">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
    /* ---------------- Firebase Setup ---------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBFDcw1HNyZp6rRLMIEKX7c6-SdR7t7NCg",
      authDomain: "esp32-agri-3c9a0.firebaseapp.com",
      databaseURL: "https://esp32-agri-3c9a0-default-rtdb.firebaseio.com",
      projectId: "esp32-agri-3c9a0",
      storageBucket: "esp32-agri-3c9a0.firebasestorage.app",
      messagingSenderId: "687937182162",
      appId: "1:687937182162:web:24e8514ce770c7117cd00b",
      measurementId: "G-H6JX4ERQYW"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ---------------- Gemini Setup ---------------- */
    const API_KEY = "AIzaSyAUHcS5KjvnthujRKl7uG7BJMTYSUZafmc"; // Replace with your Gemini API key
    const MODEL = "gemini-1.5-flash";

    const chatWindow = document.getElementById("chat-window");
    const userInput = document.getElementById("user-input");
    const cropSuggestion = document.getElementById("crop-suggestion");
    const predictBtn = document.getElementById("predict-btn");

    let latestData = { temperature: null, humidity: null, moisture: null };

    function addMessage(text, sender) {
      const msg = document.createElement("div");
      msg.classList.add("message", sender);
      msg.textContent = text;
      chatWindow.appendChild(msg);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    /* ---------------- Gemini API Call ---------------- */
    async function askGemini(prompt) {
      try {
        const res = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }]
            })
          }
        );
        const data = await res.json();
        if (data.candidates && data.candidates[0].content.parts[0].text) {
          return data.candidates[0].content.parts[0].text;
        } else {
          console.error("Gemini response error:", data);
          return "âš ï¸ No response from AI";
        }
      } catch (err) {
        return "âš ï¸ Error: " + err.message;
      }
    }

    /* ---------------- Chatbot ---------------- */
    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;
      addMessage(text, "user");
      userInput.value = "";
      addMessage("Thinking...", "bot");

      const reply = await askGemini(text);
      document.querySelector(".bot:last-child").remove();
      addMessage(reply, "bot");
    }

    userInput.addEventListener("keypress", e => {
      if (e.key === "Enter") sendMessage();
    });

    /* ---------------- Button-based Crop Suggestion ---------------- */
    predictBtn.addEventListener("click", async () => {
      if (!latestData.temperature) {
        cropSuggestion.textContent = "âš ï¸ No sensor data available";
        return;
      }

      const prompt = `You are an expert in agriculture. Based on the following data, 
      suggest the best crop to grow: 
      Temperature: ${latestData.temperature} Â°C, 
      Humidity: ${latestData.humidity} %, 
      Soil Moisture: ${latestData.moisture} %. 
      Reply with only the crop name.`;

      cropSuggestion.textContent = "ðŸŒ¾ Best Crop Suggestion: Thinking...";
      const reply = await askGemini(prompt);
      cropSuggestion.textContent = "ðŸŒ¾ Best Crop Suggestion: " + reply;
    });

    /* ---------------- Get Sensor Data ---------------- */
    db.ref("sensorData").on("value", snapshot => {
      const data = snapshot.val();
      console.log("Firebase data:", data); // Debug log
      if (data) {
        document.getElementById("temperature").textContent = data.temperature + " Â°C";
        document.getElementById("humidity").textContent = data.humidity + " %";
        document.getElementById("moisture").textContent = data.moisture + " %";

        // Save data for button use
        latestData = data;
      } else {
        console.warn("âš ï¸ No sensor data found in Firebase.");
      }
    }, error => {
      console.error("Firebase read failed:", error);
    });
  </script>
</body>
</html>
