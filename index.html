<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üå± Smart Crop Recommendation</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #f9fafb; margin: 0; padding: 20px; }
    h1 { text-align: center; margin-bottom: 20px; }

    .sensor-row { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
    .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); min-width: 150px; text-align: center; }
    .value { font-size: 22px; font-weight: bold; margin-top: 10px; }

    .info-row { background: #e0f7e9; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 20px; font-size: 18px; line-height: 1.8; }
    #crop-img { max-width: 200px; margin-top: 15px; border-radius: 10px; display: none; }

    #predict-btn { display: block; margin: 0 auto 20px auto; padding: 12px 20px; font-size: 16px; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; }
    #predict-btn:hover { background: #1d4ed8; }

    .chatbot { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
    .chatbot h2 { text-align: center; margin-bottom: 10px; }
    #chat-box { height: 250px; overflow-y: auto; border: 1px solid #ccc; border-radius: 8px; padding: 10px; margin-bottom: 10px; }
    .chat-input { display: flex; gap: 10px; }
    .chat-input input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
    .chat-input button { padding: 8px 12px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .chat-input button:hover { background: #45a049; }

    .msg { margin: 5px 0; padding: 8px; border-radius: 6px; }
    .user-msg { background: #d1e7dd; text-align: right; }
    .bot-msg { background: #f8d7da; text-align: left; }
    .thinking { font-style: italic; color: gray; }
  </style>
</head>
<body>
  <h1>üå± Smart Crop Recommendation</h1>

  <!-- Row 1: Sensors -->
  <div class="sensor-row">
    <div class="card">
      <h2>Moisture</h2>
      <div id="moisture" class="value">-- %</div>
    </div>
    <div class="card">
      <h2>Temperature</h2>
      <div id="temperature" class="value">-- ¬∞C</div>
    </div>
    <div class="card">
      <h2>Humidity</h2>
      <div id="humidity" class="value">-- %</div>
    </div>
  </div>

  <!-- Predict Button -->
  <button id="predict-btn" onclick="predictCrop()">üåæ Predict Best Crop</button>

  <!-- Row 2: Crop Info -->
  <div class="info-row">
    <div id="crop">üåæ Best Crop Suggestion: --</div>
    <div id="irrigation">üíß Irrigation Type: --</div>
    <div id="fertilizer">üåø Fertilizer Used: --</div>
    <img id="crop-img" src="" alt="Crop Image">
  </div>

  <!-- Row 3: Chatbot -->
  <div class="chatbot">
    <h2>ü§ñ Gemini Chatbot</h2>
    <div id="chat-box"></div>
    <div class="chat-input">
      <input type="text" id="user-input" placeholder="Type your question...">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
    /* ---------------- Firebase Setup ---------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBFDcw1HNyZp6rRLMIEKX7c6-SdR7t7NCg",
      authDomain: "esp32-agri-3c9a0.firebaseapp.com",
      databaseURL: "https://esp32-agri-3c9a0-default-rtdb.firebaseio.com",
      projectId: "esp32-agri-3c9a0",
      storageBucket: "esp32-agri-3c9a0.firebasestorage.app",
      messagingSenderId: "687937182162",
      appId: "1:687937182162:web:24e8514ce770c7117cd00b",
      measurementId: "G-H6JX4ERQYW"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let cropData = [];
    let latestSensor = { temp: 0, hum: 0, moist: 0 };

    /* ---------------- Load Dataset ---------------- */
    Papa.parse("Smart_Farming_Crop_Yield_2024.csv", {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: function(results) {
        cropData = results.data;
        console.log("‚úÖ Dataset loaded", cropData);
      }
    });

    /* ---------------- Helper: Find Best Crop ---------------- */
    function findBestCrop(temp, hum, moist) {
      let bestCrop = "Unknown";
      let bestIrrigation = "--";
      let bestFertilizer = "--";
      let bestScore = Infinity;

      cropData.forEach(row => {
        const dMoist = row["soil_moisture_%"];
        const dTemp = row["temperature_C"];
        const dHum = row["humidity_%"];

        if (dMoist != null && dTemp != null && dHum != null) {
          let score = Math.abs(temp - dTemp) + Math.abs(hum - dHum) + Math.abs(moist - dMoist);
          if (score < bestScore) {
            bestScore = score;
            bestCrop = row["crop_type"];
            bestIrrigation = row["irrigation_type"];
            bestFertilizer = row["fertilizer_type"];
          }
        }
      });

      return { crop: bestCrop, irrigation: bestIrrigation, fertilizer: bestFertilizer };
    }

    /* ---------------- Crop Images (Local) ---------------- */
    /* ---------------- Crop Images ---------------- */
const cropImages = {
  "rice": "images/rice.jpg",
  "wheat": "images/wheat.jpg",
  "maize": "images/maize.jpg",
  "sugarcane": "images/sugarcane.jpg",
  "cotton": "images/cotton.jpg",
  "soybean": "images/soybean.jpg",
  "barley": "images/barley.jpg",
  "millet": "images/millet.jpg",
  "groundnut": "images/groundnut.jpg",
  "sunflower": "images/sunflower.jpg",
  "potato": "images/potato.jpg",
  "tomato": "images/tomato.jpg",
  "onion": "images/onion.jpg",
  "chili": "images/chili.jpg",
  "brinjal": "images/brinjal.jpg",
  "cabbage": "images/cabbage.jpg",
  "cauliflower": "images/cauliflower.jpg",
  "peas": "images/peas.jpg",
  "mustard": "images/mustard.jpg",
  "banana": "images/banana.jpg"
};


    /* ---------------- Fetch Sensor Data ---------------- */
    db.ref("sensorData").on("value", snapshot => {
      const data = snapshot.val();
      if (data) {
        latestSensor.temp = parseFloat(data.temperature) || 0;
        latestSensor.hum = parseFloat(data.humidity) || 0;
        latestSensor.moist = parseFloat(data.moisture) || 0;

        document.getElementById("temperature").textContent = latestSensor.temp + " ¬∞C";
        document.getElementById("humidity").textContent = latestSensor.hum + " %";
        document.getElementById("moisture").textContent = latestSensor.moist + " %";
      }
    });

    /* ---------------- Predict Crop (Button) ---------------- */
    function predictCrop() {
      if (cropData.length > 0) {
        const result = findBestCrop(latestSensor.temp, latestSensor.hum, latestSensor.moist);
        document.getElementById("crop").textContent = "üåæ Best Crop Suggestion: " + result.crop;
        document.getElementById("irrigation").textContent = "üíß Irrigation Type: " + result.irrigation;
        document.getElementById("fertilizer").textContent = "üåø Fertilizer Used: " + result.fertilizer;

        const img = document.getElementById("crop-img");
        if (cropImages[result.crop.toLowerCase()]) {
          img.src = cropImages[result.crop.toLowerCase()];
          img.style.display = "block";
        } else {
          img.style.display = "none";
        }
      } else {
        alert("Dataset not loaded yet!");
      }
    }

    /* ---------------- Gemini Chatbot ---------------- */
    const GEMINI_API_KEY = "AIzaSyDhbyQzSm_0xensbNczdFX6WsjzhlWkMHY"; // üîë replace with your Gemini API key

    async function sendMessage() {
      const input = document.getElementById("user-input").value;
      if (!input) return;

      const chatBox = document.getElementById("chat-box");
      chatBox.innerHTML += `<div class="msg user-msg">${input}</div>`;

      // Show thinking placeholder
      const thinkingId = "thinking-" + Date.now();
      chatBox.innerHTML += `<div id="${thinkingId}" class="msg bot-msg thinking">ü§î Thinking...</div>`;
      chatBox.scrollTop = chatBox.scrollHeight;

      document.getElementById("user-input").value = "";

      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ parts: [{ text: input }] }]
            })
          }
        );
        const data = await response.json();
        const botReply = data?.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I didn‚Äôt get that.";

        // Replace thinking with reply
        document.getElementById(thinkingId).outerHTML = `<div class="msg bot-msg">${botReply}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
      } catch (error) {
        document.getElementById(thinkingId).outerHTML = `<div class="msg bot-msg">‚ö†Ô∏è Error connecting to Gemini</div>`;
      }
    }
  </script>
</body>
</html>
